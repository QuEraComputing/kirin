# AGENTS.md

## Principles

- less standalone function is better
- every module only expects a few names to be imported, do not create giant sets of new names
- if we have a lot of implementations (over 200 lines), it is better to split them into multiple files.
- use `mod.rs` over `<name>.rs` for modules that contain multiple files.
- when creating tests, always put common tools created for testing in the `kirin-test-utils` crate, unless they are specific to a single crate.

## Build and Test

```bash
cargo build --workspace          # Build all crates
cargo test --workspace           # Run all tests
cargo test -p kirin-chumsky      # Test a single crate
cargo test -p kirin-chumsky-derive test_parse_add  # Run a single test
cargo fmt --all                  # Format code
cargo insta review               # Review snapshot test changes
cargo xtask quick-validate .agents/skills/<skill-name>  # Validate a skill's SKILL.md frontmatter/rules
cargo xtask new-rfc "<title>" [--status <status> --author <name> ...]  # Render rfc/<id>-<title>.md from the Tera template rfc/0000-template.md (`--update` refreshes timestamp on existing RFC)
```

Rust edition 2024. No `rust-toolchain.toml`; uses the default toolchain.

## Commit Messages

Use [Conventional Commits](https://www.conventionalcommits.org/): `<type>(<scope>): <description>`

Examples: `feat(chumsky): add region parser`, `fix(derive): handle empty enum variants`

Avoid large paragraphs in commit messages, keep them concise and focused on the changes made.

## RFC Status Policy

- If an RFC is generated by skills during implementation work, set RFC metadata `status` to `Implemented`.

## Project structure

- `design` contains design documents and diagrams.
- `example` contains example code of the top-level crate `kirin`
- `tests` contains integration tests for the top-level crate `kirin`
- `crates` contains the crates that make up the project, most implementation can be found here.
- `.agents` contains agent specific implementations that is not included in this file, e.g skills.

### Crates

**Core:**
- `kirin-ir` — IR types, `Dialect` trait
- `kirin-lexer` — Logos tokenizer

**Parser/Printer:**
- `kirin-chumsky` — Parser traits (`HasParser`, `HasRecursiveParser`, `EmitIR`)
- `kirin-prettyless` — Pretty printer (`PrettyPrint`)
- `kirin-chumsky-derive` — `#[derive(HasParser, PrettyPrint)]`
- `kirin-chumsky-format` — Code generation (internal)

**Dialects:**
- `kirin-cf`, `kirin-scf`, `kirin-constant`

**Derive Infrastructure:**
- `kirin-derive-core` — Shared derive utilities
- `kirin-derive`, `kirin-derive-dialect` — `#[derive(Dialect)]`
